```
ZIP: 234
Title: Smooth Out The Block Subsidy Issuance
Owners: Jason McGee <jason@shieldedlabs.com>
        Mark Henderson <mark@equilibrium.co>
        Tomek Piotrowski <tomek@eiger.co>
        Mariusz Pilarek <mariusz@eiger.co>
        Paul Dann <paul@eiger.co>
Original-Authors: Nathan Wilcox
Credits:
Status: Draft
Category: Consensus
Created: 2023-08-23
License: BSD-2-Clause
```

# Terminology

The key words “MUST”, “SHOULD”, “SHOULD NOT”, “MAY”, “RECOMMENDED”, “OPTIONAL”,
and “REQUIRED” in this document are to be interpreted as described in RFC 2119. [1]

"Network upgrade" - to be interpreted as described in ZIP 200. [2]

"Block Subsidy” - the algorithmic issuance of ZEC on block creation. Part of the
consensus rules. Split between the miner and the Dev Fund. Also known as Block
Reward.

"Issuance" - The method by which ZEC becomes available for circulation on the network.

Let `PostBlossomHalvingInterval` be as defined in [#protocol-diffadjustment]_.

"`MAX_MONEY`" is the total ZEC supply cap, defined as 21,000,000 ZEC. This is
slightly larger than the supply cap for the current issuance mechanism, but is
the value used in existing critical consensus checks.

# Abstract

This ZIP proposes a change to how nodes calculate the block subsidy.

Instead of following a step function around the 4-year halving intervals
inherited from Bitcoin, we propose a smooth logarithmic curve, defined as a
fixed portion of the current ZSF balance (introduced in ZIP-233) at a given
block height.

The new issuance scheme would approximate the current issuance over 4-year
intervals, assuming no deposits into the ZSF during that time, and retains the
overall supply cap of `MAX_MONEY`.

# Motivation

* We want to introduce some automated mechanism to make use of funds deposited
  into the ZSF.
* We want ZSF funds to be used for long-term benefit of the network.
* We want to retain the existing total ZEC supply cap (around 21 million ZEC).
* We want the issuance rate to remain similar to the historical rate for Zcash
  (and before that, Bitcoin).
* We want issuance to be easy for all network users to understand and predict.

The current Zcash economic model, inherited from Bitcoin, includes a halving
mechanism which dictates the issuance of new coins. Halvings can lead to abrupt
changes in the rate of new coins being introduced to the market, potentially
disrupting the network's economic model, impacting its security and stability.
Furthermore, the halvings schedule is fixed and does not provide any way to
"recycle" funds into future issuance.

The proposed new ZSF-based issuance scheme solves these problems by ensuring a
more consistent and predictable rate of coin issuance, whilst preserving the
core aspects of Zcash's issuance policy. At the same time, it introduces the
first mechanism for payout from the Sustainability Fund (ZSF), essentially
distributing ZSF deposits and unclaimed transaction fees across all future block
subsidies.

# Requirements

Smoothing the issuance curve is possible using an exponential decay formula
that satisfies the following requirements:

1. The issuance can be summarised into a reasonably simple explanation
2. Block subsidies approximate a continuous function
3. If there are funds in the ZSF, then the block subsidy must be non-zero,
   preventing any final “unmined” zatoshis
4. For any 4 year period, all paid out block subsidies are approximately equal
   to half of the ZSF at the beginning of that 4 year period, if there are no
   deposits into the ZSF during those 4 years
5. Decrease the short-term impact of the deployment of this ZIP on block reward
   recipients, and minimise the potential reputation risk to Zcash of changing
   the block reward amount.

TODO daira: add a requirement that makes the initial total issuance match the previous total issuance

# Specification

## Definitions

`BLOCK_SUBSIDY_FRACTION` = 4126 / 10,000,000,000 or `0.0000004126`

`DEPLOYMENT_BLOCK_HEIGHT` = 2726400

`ZSF_BALANCE` = `MAX_MONEY - ChainValue`, where `ChainValue` includes all ZEC available on the network at a given block height, across all value pools

`ZsfBalanceAfter(block_height)` = `ZSF_BALANCE` as calculated above the specified block height

## Issuance Calculation

At the `DEPLOYMENT_BLOCK_HEIGHT`, nodes should switch from the current issuance
calculation, to the following:

`BlockSubsidy(block_height) = ceiling(BLOCK_SUBSIDY_FRACTION * ZsfBalanceAfter(block_height - 1))`

# Rationale

* Using an exponential decay function satisfies **Requirements 1** and **2** above.
* We round up to the next zatoshi to satisfy **Requirement 3** above.

## `BLOCK_SUBSIDY_FRACTION`

Let `IntendedZSFFractionRemainingAfterFourYears` = 0.5.

The value `4126 / 10_000_000_000` satisfies the approximation within +0.002%:

`(1 - BLOCK_SUBSIDY_FRACTION)^PostBlossomHalvingInterval ≈ IntendedZSFFractionRemainingAfterFourYears`

Meaning after a period of 4 years around half of `ZSF_BALANCE` will be paid out
as block subsidies, thus satisfying **Requirement 4**.

The largest possible amount in the ZSF is `MAX_MONEY`, in the theoretically
possible case that all issued funds are deposited back into the ZSF. If this
happened, the largest interim sum in the block subsidy calculation would be
`MAX_MONEY * 4126 + 10000000000`.

This uses 62.91 bits, which is just under the 63 bit limit for 64-bit signed
two's-complement integer amount types.

The numerator could be brought closer to the limit by using a larger
denominator, but the difference in the amount issued would be very small. So we
chose a power-of-10 denominator for simplicity.

TODO for ZIP owners: How many ZEC per day?

## `DEPLOYMENT_BLOCK_HEIGHT`

The deployment should happen at the next halving, which is block `2726400`.

Since there is a planned halving at this point, there will already be a
significant "shock" caused by the drop in issuance caused by the halving. This
reduces surprise and thus increases security, satisfying **Requirement 5**.
Also, due to the nature of the smoothed curve having a portion of the curve
above the respective step function line at times, this will maximally _reduce_
the issuance shock at the `DEPLOYMENT_BLOCK_HEIGHT`.

## Visualization of the Smoothed Curve

The following graph illustrates compares issuance for the current halving-based
step function vs the smoothed curve.

![A graph showing a comparison of the halving-based step function vs the smoothed curve](../rendered/assets/images/zip-0234-block_subsidy.png)

The graph below shows the balance of the ZSF assuming smooth issuance is
implemented.

![A graph showing the balance of the ZSF assuming smooth issuance is implemented](../rendered/assets/images/zip-0234-balance.png)

# Deployment

The implementation of this ZIP MUST be deployed at the same time or after the
Zcash Sustainability Fund is established (ZIP-0233).

# Appendix: Simulation

The [ZSF simulator](https://github.com/eigerco/zsf-simulator) allows us to
simulate the effects of this ZIP on the ZSF balance and the block subsidy, as
well as generate plots like the ones above. Its output:

```
Last block is 47917869 in ~113.88 years
```

indicates that, assuming that no ZEC is ever deposited into the ZSF, its balance
will be depleted after 113.88 years, and the block subsidy will be 0 ZEC after
that point.

This fragment of the output

```
Halving  1 at block  1680000:
  ZSF subsidies:    262523884819889 (~ 2625238.848 ZEC,        1.563 ZEC per block)
  legacy subsidies: 262500000000000 (~ 2625000.000 ZEC,        1.562 ZEC per block)
  difference:           23884819889 (~         238 ZEC),         ZSF/legacy: 1.0001
```

shows that the difference between the smoothed out and the current issuance
schemes is 238 ZEC after 1680000 blocks (aroound 4 years).

# References

[1] RFC-2119: https://datatracker.ietf.org/doc/html/rfc2119

[2] [ZIP-200: Network Upgrade Mechanism](zip-0200.rst)

[3] [ZIP_233: Establish the Zcash Sustainability Fund on the Protocol
Level](zip-0233.md)
